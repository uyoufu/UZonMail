import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,a as n,o as l}from"./app-D9t6Tz40.js";const t={};function e(h,i){return l(),a("div",null,i[0]||(i[0]=[n(`<p>受限于 VPS 性能，入门机通常只有 1 核、1G内存、SSD20G，无法通过 Docker 的方式安装 Mailcow 之类的邮局软件，因此只能安装更底层的 postfix 来实现自建邮局。</p><p>本节教程将按生产级的标准，总结了如何在主机上安装 postfix。</p><blockquote><p>本节内容均以域名 <code>uzoncloud.com</code> 为例, 假设机器配置为 1 核 1G, 20G 硬盘</p></blockquote><h2 id="方案对比" tabindex="-1"><a class="header-anchor" href="#方案对比"><span>方案对比</span></a></h2><p>目前比较流行的方案有：</p><ol><li>Mailcow</li><li>iReadMail</li><li>postfix</li></ol><p><strong>Mailcow</strong> 是目前最受欢迎的开源邮件服务器之一，具有企业级的品质，它基于 postfix 构建。</p><p>前两者软件比较重，对机器要求高一些。</p><p>受限于机器性能，最终决定使用 postfix 方案</p><h2 id="方案细化" tabindex="-1"><a class="header-anchor" href="#方案细化"><span>方案细化</span></a></h2><p>受限于机器性能，为了减少性能的损耗，选择最底层的实现，往往是最经济的，推荐方案如下：</p><table><thead><tr><th>序号</th><th>软件</th><th>用途</th></tr></thead><tbody><tr><td>1</td><td>postfix</td><td>实现了 SMTP(S) 协议，用于发件</td></tr><tr><td>2</td><td>Dovecot</td><td>实现了 pop3 及 imap 协议，用于保存邮件及其它客户端登录连接到邮件服务</td></tr></tbody></table><h2 id="软件安装" tabindex="-1"><a class="header-anchor" href="#软件安装"><span>软件安装</span></a></h2><p>本节为软件安装实操，可根据对应内容，将域名修改为自己的域名，基本每一个配置都有说明，方便理解。主要的步骤如下：</p><ol><li><p>在域名托管商处配置 DNS 服务</p><p>主要配置邮件服务器名称、MX、SPF、DMARC、DKIM、SMTP域名、POP域名、IMAP 域名。这些概念现在不需要理解，在 [DNS 配置](#DNS 配置) 章节中会有介绍。</p></li><li><p>安装 postfix</p><p>主要将自己的域名信息更新到配置中，然后启动 TLS 或 STARTTLS</p></li><li><p>安装 Dovecot</p><p>配置 IMAP、POP 协议，配置 smtp 授权</p></li><li><p>安装 opendkim</p><p>用于 DKIM 加密与验证</p></li><li><p>配置 RDNS，也叫 PTR</p></li></ol><h3 id="dns-配置" tabindex="-1"><a class="header-anchor" href="#dns-配置"><span>DNS 配置</span></a></h3><p><strong>所有 DNS 见下表</strong></p><table><thead><tr><th>类型</th><th>名称</th><th>完整域名</th><th>内容</th><th>作用</th><th>必须</th></tr></thead><tbody><tr><td>A</td><td>mail1</td><td><a href="http://mail1.uzonmail.com" target="_blank" rel="noopener noreferrer">mail1.uzonmail.com</a></td><td>IP地址</td><td>服务器名称；RDNS</td><td>是</td></tr><tr><td>MX</td><td>@</td><td><a href="http://uzoncloud.com" target="_blank" rel="noopener noreferrer">uzoncloud.com</a></td><td><a href="http://mx.uzoncloud.com" target="_blank" rel="noopener noreferrer">mx.uzoncloud.com</a></td><td>告诉外部邮局，你的 mx 地址。</td><td>是</td></tr><tr><td>TXT</td><td>@</td><td><a href="http://uzoncloud.com" target="_blank" rel="noopener noreferrer">uzoncloud.com</a></td><td>v=spf1 a mx ip4:xx.xx.xx.xx ~all</td><td>SPF 设置，验证邮件发件人的IP地址是否被域名所有者授权发送该域名的邮件</td><td>是</td></tr><tr><td>TXT</td><td>mail1</td><td><a href="http://mail1.uzonmail.com" target="_blank" rel="noopener noreferrer">mail1.uzonmail.com</a></td><td>v=spf1 <a href="http://redirect=uzoncloud.com" target="_blank" rel="noopener noreferrer">redirect=uzoncloud.com</a></td><td>mail1 的 SPF 重定向到主域</td><td>是</td></tr><tr><td>TXT</td><td>_dmarc</td><td>_dmarc.uzoncloud.com</td><td>v=DMARC1; p=quarantine; pct=100; adkim=r; aspf=r</td><td>基于SPF和DKIM的认证结果，指定如何处理邮件认证失败的情况（如隔离或拒绝），并提供报告帮助域名所有者监控和改进邮件安全性</td><td>是</td></tr><tr><td>TXT</td><td>default._domainkey</td><td>default._domainkey.uzoncloud.com</td><td>v=DKIM1; k=rsa; p=公钥内容</td><td>DKIM 用于数字签名邮件，确保内容未被篡改</td><td>是</td></tr><tr><td>A</td><td>mx</td><td><a href="http://mx.uzonmail.com" target="_blank" rel="noopener noreferrer">mx.uzonmail.com</a></td><td>IP地址</td><td>用于别的邮局向你的服务器投递邮件 [可选]</td><td>否</td></tr><tr><td>A</td><td>smtp</td><td><a href="http://smtp.uzoncloud.com" target="_blank" rel="noopener noreferrer">smtp.uzoncloud.com</a></td><td>IP地址</td><td>约定的 smtp 域名，客户端使用 smtp 发件 [可选]</td><td>否</td></tr><tr><td>A</td><td>pop</td><td><a href="http://pop.uzoncloud.com" target="_blank" rel="noopener noreferrer">pop.uzoncloud.com</a></td><td>IP地址</td><td>约定的 pop 域名，客户端使用 pop 协议取件[可选]</td><td>否</td></tr><tr><td>A</td><td>imap</td><td><a href="http://imap.uzoncloud.com" target="_blank" rel="noopener noreferrer">imap.uzoncloud.com</a></td><td>IP地址</td><td>约定的 imap 域名，客户端使用 imap 协议复制邮件[可选]</td><td>否</td></tr></tbody></table><p>上表中，可选项可以不用添加 DNS 记录，使用某个指向服务器的域名即可。同时有以下几点要注意：</p><ol><li>若 <code>mx</code> 域名未填写，注意修改 SPF 记录中的域名</li><li>DKIM 中的私钥和公钥在 <a href="#opendkim%E5%AE%89%E8%A3%85">opendkim安装</a> 步骤中生成</li><li>mail1 配置 SPF 是为了解决 <code>SPF: HELO does not publish an SPF Record</code> 警告</li></ol><h3 id="postfix-安装" tabindex="-1"><a class="header-anchor" href="#postfix-安装"><span>postfix 安装</span></a></h3><p><strong>安装软件</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 安装时，配置类型选择: 2. Internet Site</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postfix</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>配置 <a href="http://main.cf" target="_blank" rel="noopener noreferrer">main.cf</a></strong></p><p><a href="http://main.cf" target="_blank" rel="noopener noreferrer">main.cf</a> 文件提供最少的配置参数。</p><p>以下是详细配置过程：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 配置主机名</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 主机名的作用有：</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#  1. 对外发件时，用于声明自己</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#  2. RDNS 的指向域名</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#  3. postfix 从主机名中提取域名</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 主机名习惯上是 mail.uzoncloud.com, 也可以设置为其它的</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;myhostname = mail1.uzoncloud.com&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 配置邮箱目录</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;home_mailbox = Maildir /&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 使用 SASL（Dovecot SASL）配置 Postfix 的 SMTP-AUTH</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 授权验证使用 dovecot</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtpd_sasl_type = dovecot&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtpd_sasl_path = private/auth&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtpd_sasl_local_domain = $myhostname&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtpd_sasl_security_options = noanonymous,noplaintext&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtpd_sasl_tls_security_options = noanonymous&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;broken_sasl_auth_clients = yes&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtpd_sasl_auth_enable = yes&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtpd_recipient_restrictions = permit_sasl_authenticated,permit_mynetworks,reject_unauth_destination&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 配置 SSL 证书</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 证书可以通过 acme.sh 申请, 申请后，按以下操作</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 注意, 不要使用自签名证书, 自签名在某些安全验证环境下, 会存在问题</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtp_tls_security_level = may&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtpd_tls_security_level = may&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtp_tls_note_starttls_offer = yes&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtpd_tls_key_file = /etc/nginx/conf.d/cert/uzoncloud.com.key&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtpd_tls_cert_file = /etc/nginx/conf.d/cert/uzoncloud.com.cert&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtpd_tls_loglevel = 1&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtpd_tls_received_header = yes&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;smtpd_tls_auth_only = yes&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>配置 SMTPS</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 在 main.cf 中添加一些 MUA 安全限制</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># MUA 是 Mail User Agent（邮件用户代理）的缩写, 它指的是客户端邮件软件，如 Outlook、Thunderbird 或手机邮件应用，用于发送和接收邮件</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># MUA 客户端限制: 允许认证用户，其他拒绝</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;mua_client_restrictions = permit_sasl_authenticated, reject&#39;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># MUA HELO 限制：允许认证用户，其他拒绝</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;mua_helo_restrictions = permit_sasl_authenticated, reject&#39;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># MUA 发送者限制：允许认证用户，其他拒绝</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;mua_sender_restrictions = permit_sasl_authenticated, reject&#39;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># MUA 中继限制：允许认证用户，其他拒绝</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;mua_relay_restrictions = permit_sasl_authenticated, reject&#39;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># MUA 收件人限制：允许认证用户，其他拒绝</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postconf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;mua_recipient_restrictions = permit_sasl_authenticated, reject&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 编辑文件 master.cf </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nano</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/postfix/master.cf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 找到 submission, 文件中有 submission 与 submissions, 其中，前者为 STARTTLS，后者为 TLS</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 包含 -o smtpd_tls_security_level=encrypt 表示 STARTTLS, 监听 587 端口</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 包含 -o smtpd_tls_wrappermode=yes 表示 TLS, 监听 465</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 可以启用两个 submission</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 注释掉 submission 相关的配置, 如下所示</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">submission</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> inet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       -</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       y</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       -</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       -</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       smtpd</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> syslog_name=postfix/submission</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> smtpd_tls_security_level=encrypt</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> smtpd_sasl_auth_enable=yes</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> smtpd_tls_auth_only=yes</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> local_header_rewrite_clients=static:all</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> smtpd_reject_unlisted_recipient=no</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> milter_macro_daemon_name=ORIGINATING</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 然后，额外添加如下安全配置</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> smtpd_client_restrictions=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">$mua_client_restrictions</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> smtpd_client_restrictions=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">$mua_helo_restrictions</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> smtpd_sender_restriction=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">$mua_sender_restrictions</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> smtpd_relay_restrictions=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">$mua_relay_restrictions</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> smtpd_recipient_restrictions=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">$mua_recipient_restrictions</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># submissions 配置也如上操作</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 保存配置</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>重定向系统账户邮件 [可选]</strong></p><p>在Linux系统上，系统账户（如<code>root</code>、<code>postmaster</code>）的邮件通常通过 /etc/aliases 文件重定向到实际管理员用户账户。这可以防止邮件丢失到<code>/var/mail/nobody</code>。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nano</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/aliases</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 若有需要，进行以下配置</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># root: your_admin_user</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># postmaster: your_admin_user</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="dovecot-安装" tabindex="-1"><a class="header-anchor" href="#dovecot-安装"><span>Dovecot 安装</span></a></h3><p><strong>安装软件</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># dovecot-imapd 提供 imap 协议</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># dovecot-pop3d 提供 pop3 协议</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -y</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dovecot-core</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dovecot-imapd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dovecot-pop3d</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Dovecot 所有的配置位于 <code>/etc/dovecot/conf.d</code> 中，其按配置类型，拆分为了多个配置，可以根据需要对应到每个文件去修改。</p><p><strong>配置 10-auth.conf</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nano</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/dovecot/conf.d/10-auth.conf</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 将 auth_mechanisms = plain  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 改成 auth_mechanisms = plain login</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sed</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -i</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;/auth_mechanisms = plain/ { /login/! s/$/ login/; }&#39;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/dovecot/conf.d/10-auth.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>配置 10-master.conf</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nano</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/dovecot/conf.d/10-master.conf</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 将 service auth 配置块修改为如下配置，用于 Postfix 的 SMTP 认证（smtp-auth），允许 Postfix 与 Dovecot 通信进行邮件认证</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">service</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> auth</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # auth_socket_path points to this userdb socket by default. It&#39;s typically</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # used by dovecot-lda, doveadm, possibly imap process, etc. Users that have</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # full permissions to this socket are able to get a list of all usernames and</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # get the results of everyone&#39;s userdb lookups.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  #</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # The default 0666 mode allows anyone to connect to the socket, but the</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # userdb lookups will succeed only if the userdb returns an &quot;uid&quot; field that</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # matches the caller process&#39;s UID. Also if caller&#39;s uid or gid matches the</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # socket&#39;s uid or gid the lookup succeeds. Anything else causes a failure.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  #</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # To give the caller full permissions to lookup all users, set the mode to</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # something else than 0666 and Dovecot lets the kernel enforce the</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # permissions (e.g. 0777 allows everyone full permissions).</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  unix_listener</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> auth-userdb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    #mode = 0666</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    #user =</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    #group =</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # Postfix smtp-auth</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  #unix_listener /var/spool/postfix/private/auth {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  #  mode = 0666</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  #}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 以下配置为新增</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  unix_listener</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /var/spool/postfix/private/auth</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    mode</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0660</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    user</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postfix</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    group</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postfix</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # Auth process is run as this user.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  #user = $default_internal_user</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>配置 dovecot.conf</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nano</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/dovecot/dovecot.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 指定邮件存储位置</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 添加如下配置覆盖默认</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">mail_location</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> maildir:~/Maildir</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>配置 SSL</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nano</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/dovecot/conf.d/10-ssl.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 将 ssl_cert, ssl_key 改成申请的证书</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># ssl_cert = &lt;/etc/nginx/conf.d/cert/uzoncloud.com.cert</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># ssl_key = &lt;/etc/nginx/conf.d/cert/uzoncloud.com.key</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="opendkim-安装" tabindex="-1"><a class="header-anchor" href="#opendkim-安装"><span>opendkim 安装</span></a></h3><p>它通过签名出站邮件和验证入站邮件的方式，帮助防止邮件伪造和垃圾邮件，提高邮件安全性。</p><p>安装步骤如下：</p><ol><li><p>安装 opendkim</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> update</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> opendkim</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> opendkim-tools</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>生成 DKIM 密钥</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 生成密钥对</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mkdir</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/opendkim/keys/uzoncloud.com</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># -s 参数指定 selector 名称，该名称为 default._domainkey.uzoncloud.com 的三级域名名称</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 在进行配置时，也需要使用到该名称，此处使用 default</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> opendkim-genkey</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> default</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -d</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uzoncloud.com</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -D</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/opendkim/keys/uzoncloud.com</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> chown</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> opendkim:opendkim</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/opendkim/keys/uzoncloud.com/default.private</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> chmod</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 600</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/opendkim/keys/uzoncloud.com/default.private</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看公钥（用于 DNS TXT 记录）</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 使用时，只复制 () 之间的内容，同时去掉换行和引号</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/opendkim/keys/uzoncloud.com/default.txt</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>将公钥内容添加到 DNS TXT 记录中，域名为：default._domainkey.uzoncloud.com</p></li><li><p>配置 OpenDKIM 主文件 (/etc/opendkim.conf)</p><p>配置参考：<a href="https://wiki.debian.org/opendkim" target="_blank" rel="noopener noreferrer">opendkim - Debian Wiki</a></p><p>编辑文件，添加或修改以下内容：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 配置OpenDKIM</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nano</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/opendkim.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 在文件末尾追加如下配置</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 基本配置</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 规范化算法</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Canonicalization</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> relaxed</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 配置域名</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Domain</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uzoncloud.com</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 指定私钥</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">KeyFile</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/opendkim/keys/uzoncloud.com/default.private</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Selector</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> default</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Mode</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sv</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 启用端口监听</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Socket</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> inet:8891@localhost</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 表头文件</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 列出不应进行 DKIM 验证的外部主机或域名，通常与 TrustedHosts 文件相同，用于忽略某些外部邮件的签名验证，以避免误报</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># refile 表示使用正则匹配</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ExternalIgnoreList</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> refile:/etc/opendkim/TrustedHosts</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 列出内部主机或域名，这些主机的邮件将被签名而不是验证</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">InternalHosts</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> refile:/etc/opendkim/TrustedHosts</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 定义用于签名的密钥映射。它将选择器（default）和域名关联到私钥文件路径。Postfix 使用此表来确定签名邮件时使用哪个密钥</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">KeyTable</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> refile:/etc/opendkim/KeyTable</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 指定哪些发件人（域名或用户）应该使用哪些密钥进行签名。它定义签名策略，确保出站邮件被正确签名</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">SigningTable</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> refile:/etc/opendkim/SigningTable</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>创建表头文件</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 对 ExternalIgnoreList、InternalHosts、KeyTable、SigningTable 文件内容进行配置</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;default._domainkey.uzoncloud.com uzoncloud.com:default:/etc/opendkim/keys/uzoncloud.com/default.private&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/etc/opendkim/KeyTable</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;*@uzoncloud.com default._domainkey.uzoncloud.com&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/etc/opendkim/SigningTable</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">echo</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;localhost\\n127.0.0.1\\n::1\\nuzoncloud.com&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/etc/opendkim/TrustedHosts</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>验证配置文件</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> opendkim</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -n</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/opendkim.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>若验证通过，则没有任何输出</p></li><li><p>与 Postfix 结合</p><p><strong>编辑 /etc/postfix/main.cf</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 编辑 /etc/postfix/main.cf，添加 milter 配置</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 添加到 main.cf 末尾</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">milter_default_action</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> accept</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">smtpd_milters</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> inet:localhost:8891</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 或 unix:/var/run/opendkim/opendkim.sock</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">non_smtpd_milters</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> $smtpd_milters</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>编辑 /etc/postfix/master.cf [可选]</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 编辑 /etc/postfix/master.cf，在 smtp 和 submission 服务下添加 milter（可选，用于特定端口）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">smtp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      inet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       -</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       y</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       -</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       -</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       smtpd</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> smtpd_milters=inet:localhost:8891</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="用户管理" tabindex="-1"><a class="header-anchor" href="#用户管理"><span>用户管理</span></a></h3><h4 id="创建用户" tabindex="-1"><a class="header-anchor" href="#创建用户"><span>创建用户</span></a></h4><p>启动邮箱服务并新增邮箱用户</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> start</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postfix</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dovecot</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> opendkim</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 重启</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> restart</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postfix</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dovecot</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> opendkim</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 设置开机自启动</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enable</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> postfix</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dovecot</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> opendkim</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 新建用户</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 用户格式建议为邮箱号, 因为有的客户端不支持自定义 smtp 用户名</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">useradd</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -m</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> username</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 禁止用户登录</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> usermod</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/sbin/nologin</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> username</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 设置密码</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">passwd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> username</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 验证账户</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> doveadm</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> auth</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> username</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="删除用户" tabindex="-1"><a class="header-anchor" href="#删除用户"><span>删除用户</span></a></h4><p>若用户不再需要，可以删除，删除用户主要有两个步骤：</p><ol><li>删除 dovecot 已经保存的邮件</li><li>删除用户</li></ol><p>具体操作如下：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 停止 Dovecot 服务（防止删除过程中出现冲突</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> stop</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dovecot</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 删除系统用户及其 home 目录（这将删除用户的邮件数据）</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># -r 选项会删除用户的 home 目录（包括 Maildir 中的邮件）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> userdel</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -r</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> username</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 验证删除：</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 检查用户是否已删除：（应返回“no such user”）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">id</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> username</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 检查邮件目录：（应不存在）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ls</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /home/username</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 启动服务</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> start</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dovecot</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="配置-rdns、ptr" tabindex="-1"><a class="header-anchor" href="#配置-rdns、ptr"><span>配置 RDNS、PTR</span></a></h3><p>若 VPS 提供商允许，同时配置 PTR。</p><p>PTR（Pointer）记录是 DNS 中的反向 DNS（Reverse DNS）记录，用于将 IP 地址映射回对应的域名。它在邮件服务器中的主要作用包括：</p><ul><li><strong>身份验证</strong>：邮件接收服务器（如 Gmail、Outlook）会检查发件 IP 的 PTR 记录是否与发件域名匹配。如果不匹配，可能被视为可疑邮件，导致邮件被标记为垃圾或拒绝。</li><li><strong>反垃圾邮件</strong>：PTR 是 SPF、DKIM、DMARC 等认证机制的补充，帮助验证发件服务器的合法性，减少伪造邮件的风险。</li><li><strong>服务器配置</strong>：在自建邮局中，PTR 记录通常指向邮件服务器的主机名（如 <code>mail1.uzoncloud.com</code>），确保 RDNS（Reverse DNS）正确解析。</li></ul><p>配置 PTR 需要联系 VPS 提供商或域名托管商，在其 DNS 面板中添加反向记录。未正确配置 PTR 可能导致邮件投递失败或被过滤。</p><h3 id="验证邮件服务器配置" tabindex="-1"><a class="header-anchor" href="#验证邮件服务器配置"><span>验证邮件服务器配置</span></a></h3><p>可以向发送一封邮件，查看邮件得分，根据得分情况进行优化。</p><p><strong>原始配置发件结果：</strong></p><figure><img src="https://oss.uzoncloud.com:2234/public/files/images/image-20251214181802651.png" alt="未配置验证" tabindex="0" loading="lazy"><figcaption>未配置验证</figcaption></figure><p><strong>配置完成后结果：</strong></p><figure><img src="https://oss.uzoncloud.com:2234/public/files/images/image-20251215124148996.png" alt="配置验证" tabindex="0" loading="lazy"><figcaption>配置验证</figcaption></figure><h2 id="高级配置" tabindex="-1"><a class="header-anchor" href="#高级配置"><span>高级配置</span></a></h2><h3 id="大规模账号管理" tabindex="-1"><a class="header-anchor" href="#大规模账号管理"><span>大规模账号管理</span></a></h3><p>若需要进行大规模账号管理，建议安装 <code>PostFixAdmin</code>，采用数据库的试来管理多域和多账号。由于本人目前没有这方便需求，此处不介绍。</p><p>特别说明，对于自建邮局来说，多个账号与单个账号是一样的，因为多个账号如果共用同一公网IP或同一发送域，信誉是共享的，问题会互相牵连。</p><ul><li>发送速度与暖机（warm‑up）：新 IP/域需要逐步增加发送量才能建立信誉；突然大流量会触发拦截。</li><li>列表质量与互动：干净的白名单/双重确认订阅、低退信率、低投诉率、高打开/点击率有助提升到达。</li><li>内容与频率稳定性：高重复、垃圾特征、突变发送模式都会降低到达率。</li><li>黑名单与监控：持续监测 Spamhaus、Google Postmaster、Microsoft SNDS 等，及时处理问题。</li></ul><h3 id="反垃圾邮件" tabindex="-1"><a class="header-anchor" href="#反垃圾邮件"><span>反垃圾邮件</span></a></h3><p>可以使用 SpamAssassin 实现垃圾邮件检测。后期若收到的垃圾邮件较多，可以再行配置。</p><h2 id="开始使用" tabindex="-1"><a class="header-anchor" href="#开始使用"><span>开始使用</span></a></h2><p>至此，邮件服务器已经搭建成功了，可以下载 <a href="http://mail.uzoncloud.com/" target="_blank" rel="noopener noreferrer">宇正群邮</a>、Foxmail 等客户端进行使用了。</p>`,77)]))}const d=s(t,[["render",e],["__file","index.html.vue"]]),r=JSON.parse('{"path":"/self-hosted/postfix/","title":"自建 postfix 邮局","lang":"zh-CN","frontmatter":{"title":"自建 postfix 邮局","icon":"server","order":1,"description":"宇正群邮（UZonMail）是一款开源、免费、企业级的邮件群发软件，支持邮件营销、邮箱爬取、无限变量、Outlook OAuth2 等功能。多线程高效群发，支持 Windows、Linux、MacOS、Docker 等平台部署，适用于外贸、教育、财务等行业。宇正群邮——最好用的邮件群发软件，助力高效邮件营销！","head":[["meta",{"property":"og:url","content":"https://mail.uzoncloud.com/self-hosted/postfix/"}],["meta",{"property":"og:site_name","content":"宇正群邮"}],["meta",{"property":"og:title","content":"自建 postfix 邮局"}],["meta",{"property":"og:description","content":"宇正群邮（UZonMail）是一款开源、免费、企业级的邮件群发软件，支持邮件营销、邮箱爬取、无限变量、Outlook OAuth2 等功能。多线程高效群发，支持 Windows、Linux、MacOS、Docker 等平台部署，适用于外贸、教育、财务等行业。宇正群邮——最好用的邮件群发软件，助力高效邮件营销！"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://oss.uzoncloud.com:2234/public/files/images/image-20251214181802651.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-12-15T05:40:07.000Z"}],["meta",{"property":"article:modified_time","content":"2025-12-15T05:40:07.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"自建 postfix 邮局\\",\\"image\\":[\\"https://oss.uzoncloud.com:2234/public/files/images/image-20251214181802651.png\\",\\"https://oss.uzoncloud.com:2234/public/files/images/image-20251215124148996.png\\"],\\"dateModified\\":\\"2025-12-15T05:40:07.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"uyoufu\\",\\"url\\":\\"https://uyoufu.uzoncloud.com/\\"}]}"]]},"headers":[{"level":2,"title":"方案对比","slug":"方案对比","link":"#方案对比","children":[]},{"level":2,"title":"方案细化","slug":"方案细化","link":"#方案细化","children":[]},{"level":2,"title":"软件安装","slug":"软件安装","link":"#软件安装","children":[{"level":3,"title":"DNS 配置","slug":"dns-配置","link":"#dns-配置","children":[]},{"level":3,"title":"postfix 安装","slug":"postfix-安装","link":"#postfix-安装","children":[]},{"level":3,"title":"Dovecot 安装","slug":"dovecot-安装","link":"#dovecot-安装","children":[]},{"level":3,"title":"opendkim 安装","slug":"opendkim-安装","link":"#opendkim-安装","children":[]},{"level":3,"title":"用户管理","slug":"用户管理","link":"#用户管理","children":[]},{"level":3,"title":"配置 RDNS、PTR","slug":"配置-rdns、ptr","link":"#配置-rdns、ptr","children":[]},{"level":3,"title":"验证邮件服务器配置","slug":"验证邮件服务器配置","link":"#验证邮件服务器配置","children":[]}]},{"level":2,"title":"高级配置","slug":"高级配置","link":"#高级配置","children":[{"level":3,"title":"大规模账号管理","slug":"大规模账号管理","link":"#大规模账号管理","children":[]},{"level":3,"title":"反垃圾邮件","slug":"反垃圾邮件","link":"#反垃圾邮件","children":[]}]},{"level":2,"title":"开始使用","slug":"开始使用","link":"#开始使用","children":[]}],"git":{"createdTime":1765777207000,"updatedTime":1765777207000,"contributors":[{"name":"galens","username":"galens","email":"gmx_galens@163.com","commits":1,"url":"https://github.com/galens"}]},"readingTime":{"minutes":11.57,"words":3472},"filePathRelative":"self-hosted/postfix/README.md","localizedDate":"2025年12月15日"}');export{d as comp,r as data};
